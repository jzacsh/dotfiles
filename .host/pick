#!/bin/bash


# TODO this is still experimental; no idea if DBUS_SESSION_BUS_ADDRESS is
# really a reliable signal; not sure _which_ signals are really reliable.
# just trying to make sure i don't see useless errors when i login via SSH
# and/or a seated TTY
is_desktop_env() (
  [[ -n "$DISPLAY" ]] && [[ -n "$DBUS_SESSION_BUS_ADDRESS" ]]
)

# useful catalog of some env. variables in this space:
#   https://wiki.archlinux.org/index.php/Environment_variables#Examples
get_desktop_env() (
  local deEnv="$DE"
  [[ -n "$DE" ]] || deEnv="$DESKTOP_SESSION"
  echo "$deEnv"
)

src_this() {
  local target="$1"
  if ! [[ -s "$target" ]] || ! [[ -r "$target" ]] || ! [[ -f "$target" ]];then
    log_jzdots warn '~/%-15s not readable, non-empty file\n' "${target/$HOME\/}"
    return # don't error return; don't want to stop my own shell login
  fi
  source "$target"
}

src_all() {
    local distroSuffix hostSuffix deSuffix domainSuffix

    #
    # generic distro-specific config
    #
    if [[ -f /etc/arch-release ]]; then
      distroSuffix=arch
    elif [[ -f /etc/lsb-release ]]; then
      distroSuffix="$(awk -F'=' '/^DISTRIB_ID/{print tolower($2)}' /etc/lsb-release)"
    elif [[ -f /etc/debian_version ]];then
      distroSuffix=debian
    fi

    #
    # host-specific configuration
    #
    hostSuffix="${HOSTNAME/.*/}" #mimic `hostname -s`

    #
    # DE(GUI)-specific configuration
    #
    if is_desktop_env;then
      deSuffix="$(get_desktop_env)"

      # provide a fallback with some basics that are X11 "specific" but not
      # really DE-specific
      [[ -n "$deSuffix" ]] || deSuffix=_jzacshcatchall
    fi

    #
    # domain-specific configuration
    #
    domainSuffix="$(hostname --domain)"

    #
    # actually source everything all at once
    #
    local dir="$HOME/.host"

    log_jzdots info \
      '~/.host forest-walk: distro="%s", host="%s", DE="%s" domain="%s"\n' \
      "$distroSuffix" "$hostSuffix" "${deSuffix:-n/a}" "$domainSuffix"

    src_this "${dir}/distro.${distroSuffix}"
    src_this "${dir}/host.${hostSuffix}"
    [[ -z "$deSuffix" ]] ||
      src_this "${dir}/deskenv.${deSuffix}"
    [[ -z "$domainSuffix" ]] ||
      src_this "${dir}/domain.${domainSuffix}"
}

src_all
unset src_all src_this
