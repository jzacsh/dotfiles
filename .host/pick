#!/bin/bash

src_this() {
  local target="$1"
  if ! [[ -f "$target" ]] || ! [[ -r "$target" ]];then
    local col_ylw='\e[0;33m' col_end='\033[0m'
    local t; printf -v t '%s%s' "${target/$HOME\/}"
    local logPrefix="$col_ylw"'WARNING'"$col_end"
    printf \
      "$logPrefix"': ~/%-15s not readable file\n' \
      "$t" >&2
    return # don't error return; don't want to stop my own shell login
  fi
  source "$target"
}

src_all() {
    local prefix dir; dir="$HOME/.host"

    local col_ylw='\e[1;34m' col_end='\033[0m'
    local log_prefix="$col_ylw"'INFO'"$col_end"
    printf "$log_prefix"': walking through ~/.host/ forrest...\n'

    #
    # generic distro-specific config
    #
    prefix="$dir"/distro.
    if [[ -f /etc/arch-release ]]; then
        src_this "${prefix}arch"
    elif [[ -f /etc/lsb-release ]]; then
        deb_dist_file=${prefix}$(awk -F'=' '/^DISTRIB_ID/{print tolower($2)}' /etc/lsb-release)
        src_this "$deb_dist_file"
    fi

    #
    # host-specific configuration
    #
    local hostfile; hostfile="$dir/host.${HOSTNAME/.*/}" #mimic `hostname -s`
    src_this "$hostfile"

    #
    # domain-specific configuration
    #
    src_this "$dir/domain.$(hostname --domain)"

    printf "$log_prefix"': ... DONE with ~/.host/ forrest.\n'
}

src_all
unset src_all src_this
