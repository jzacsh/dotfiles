#!/bin/bash


# TODO this is still experimental; no idea if DBUS_SESSION_BUS_ADDRESS is
# really a reliable signal; not sure _which_ signals are really reliable.
# just trying to make sure i don't see useless errors when i login via SSH
# and/or a seated TTY
is_desktop_env() (
  [[ -n "$DISPLAY" ]] && [[ -n "$DBUS_SESSION_BUS_ADDRESS" ]]
)

# useful catalog of some env. variables in this space:
#   https://wiki.archlinux.org/index.php/Environment_variables#Examples
get_desktop_env() (
  local deEnv="$DE"
  [[ -n "$DE" ]] || deEnv="$DESKTOP_SESSION"
  echo "$deEnv"
)

src_this() {
  local target="$1"
  if ! [[ -f "$target" ]] || ! [[ -r "$target" ]];then
    log_jzdots warn '~/%-15s not readable file\n' "${target/$HOME\/}"
    return # don't error return; don't want to stop my own shell login
  fi
  source "$target"
}

src_all() {
    local prefix dir; dir="$HOME/.host"

    #
    # generic distro-specific config
    #
    prefix="$dir"/distro.
    if [[ -f /etc/arch-release ]]; then
        src_this "${prefix}arch"
    elif [[ -f /etc/lsb-release ]]; then
        deb_dist_file=${prefix}$(awk -F'=' '/^DISTRIB_ID/{print tolower($2)}' /etc/lsb-release)
        src_this "$deb_dist_file"
    fi

    #
    # host-specific configuration
    #
    local hostfile; hostfile="$dir/host.${HOSTNAME/.*/}" #mimic `hostname -s`
    src_this "$hostfile"

    #
    # DE(GUI)-specific configuration
    #
    if is_desktop_env;then
      prefix="$dir"/deskenv.
      deEnv="$(get_desktop_env)"

      # provide a fallback with some basics that are X11 "specific" but not
      # really DE-specific
      [[ -n "$deEnv" ]] || deEnv=_jzacshcatchall
      src_this "${prefix}${deEnv}"
    fi

    #
    # domain-specific configuration
    #
    src_this "$dir/domain.$(hostname --domain)"
}

src_all
unset src_all src_this
