#!/bin/bash

src_this() {
  if ! [[ -f "$1" ]] || ! [[ -r "$1" ]];then
    printf 'CRITICAL ERROR: .host/ forest: "%s" not a readable file\n' "$1" >&2
    return # don't error return; don't want to stop my own shell login
  fi
  source "$1"
}

src_all() {
    local prefix dir; dir="$HOME/.host"

    #
    # generic distro-specific config
    #
    prefix="$dir"/distro.
    if [[ -f /etc/arch-release ]]; then
        src_this "${prefix}arch"
    elif [[ -f /etc/lsb-release ]]; then
        deb_dist_file=${prefix}$(awk -F'=' '/^DISTRIB_ID/{print tolower($2)}' /etc/lsb-release)
        src_this "$deb_dist_file"
    fi

    #
    # host-specific configuration
    #
    local hostfile; hostfile="$dir/host.${HOSTNAME/.*/}" #mimic `hostname -s`
    src_this "$hostfile"

    # domain-specific configuration
    src_this "$dir/domain.$(hostname --domain)"
}

src_all
unset src_all src_this
